<!DOCTYPE html>
<html>
<head>
    <title>Advanced Flight Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { width: 100vw; height: 100vh; }

        #locate-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 10px 15px;
            font-size: 14px;
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }
        #locate-btn:hover { background-color: #f4f4f4; }

        .airplane-icon {
            width: 40px; height: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23FFC700' stroke='black' stroke-width='3' d='M50 0 L55 35 L98 48 L98 52 L55 65 L55 85 L70 90 L70 95 L52 95 L50 100 L48 95 L30 95 L30 90 L45 85 L45 65 L2 52 L2 48 L45 35 Z'/%3E%3C/svg%3E");
            background-size: contain; background-repeat: no-repeat; transition: transform 0.5s linear;
        }

        .flight-info-tooltip { background-color: white; border: 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); padding: 12px; white-space: nowrap; }
        .flight-info-tooltip .flight-model { font-weight: bold; color: #111; }
        .flight-info-tooltip .flight-number-line { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
        .flight-info-tooltip .flight-route { color: #444; font-size: 0.9em; }
        .flight-info-tooltip .flag-emoji { font-size: 18px; line-height: 1; }
    </style>
</head>
<body>

<div id="map"></div>
<button id="locate-btn">Detect My Location</button>

<script>
    let homeCoordinates = L.latLng(51.478431, -0.113217); // Default to London
    const map = L.map('map').setView(homeCoordinates, 11);
    let homeMarker = L.marker(homeCoordinates).addTo(map).bindPopup("Home Location");

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 18,
    }).addTo(map);

    const flightMarkers = {};
    const aircraftModelCache = {};
    const flightRouteCache = {};

    // --- Caching and Helper Functions ---
    const countryToCode = { "United Kingdom": "GB", "Germany": "DE", "France": "FR", "Spain": "ES", "Ireland": "IE", "Netherlands": "NL", "United States": "US", "Canada": "CA", "Switzerland": "CH", "Italy": "IT", "Portugal": "PT", "Belgium": "BE", "Turkey": "TR", "Poland": "PL", "Luxembourg": "LU", "Austria": "AT", "Denmark": "DK", "Sweden": "SE", "Norway": "NO", "Finland": "FI", "Greece": "GR", "Qatar": "QA", "United Arab Emirates": "AE"};
    function countryCodeToEmoji(countryCode) {
        if (!countryCode || countryCode.length !== 2) return '✈️';
        const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt());
        return String.fromCodePoint(...codePoints);
    }

    async function getAircraftModel(icao24) {
        if (aircraftModelCache[icao24]) return aircraftModelCache[icao24];
        try {
            // This API is not official and may be unreliable. A proper solution would use a paid database.
            const response = await fetch(`https://opensky-network.org/api/metadata/aircraft/icao/${icao24}`);
            if (!response.ok) throw new Error();
            const data = await response.json();
            const model = data.model || "Unknown Model";
            aircraftModelCache[icao24] = model;
            return model;
        } catch (e) {
            aircraftModelCache[icao24] = "Aircraft"; // Cache failure to avoid re-fetching
            return "Aircraft";
        }
    }

    async function getFlightRoute(icao24) {
        if (flightRouteCache[icao24]) return flightRouteCache[icao24];
        try {
            const now = Math.floor(Date.now() / 1000);
            const begin = now - 86400; // 24 hours ago
            const response = await fetch(`https://opensky-network.org/api/flights/aircraft?icao24=${icao24}&begin=${begin}&end=${now}`);
            if (!response.ok) throw new Error();
            const data = await response.json();
            if (data.length > 0) {
                const route = {
                    origin: data[0].estDepartureAirport || 'N/A',
                    dest: data[0].estArrivalAirport || 'N/A'
                };
                flightRouteCache[icao24] = route;
                return route;
            }
        } catch (e) {/* Fallthrough to default */}
        const defaultRoute = { origin: 'N/A', dest: 'N/A' };
        flightRouteCache[icao24] = defaultRoute;
        return defaultRoute;
    }

    // --- Main Fetch and Update Function ---
    async function fetchFlightData() {
        const bounds = map.getBounds().pad(0.5);
        const url = `https://opensky-network.org/api/states/all?lamin=${bounds.getSouth()}&lomin=${bounds.getWest()}&lamax=${bounds.getNorth()}&lomax=${bounds.getEast()}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response failed');
            const data = await response.json();

            if (!data || !data.states) return;

            const flightsWithDistance = data.states
                .filter(f => f[5] && f[6] && !f[8])
                .map(f => ({ flight: f, distance: homeCoordinates.distanceTo([f[6], f[5]]) }));

            flightsWithDistance.sort((a, b) => a.distance - b.distance);
            const closestFlights = flightsWithDistance.slice(0, 5);
            const closestIcaos = new Set(closestFlights.map(f => f.flight[0]));

            for (const { flight, distance } of closestFlights) {
                const icao24 = flight[0];
                const callsign = flight[1] ? flight[1].trim() : 'N/A';
                const origin_country = flight[2];
                const position = L.latLng(flight[6], flight[5]);
                const true_track = flight[10];

                const [model, route] = await Promise.all([getAircraftModel(icao24), getFlightRoute(icao24)]);
                
                const countryCode = countryToCode[origin_country] || null;
                const flagEmoji = countryCodeToEmoji(countryCode);
                const distanceKm = (distance / 1000).toFixed(1);

                const tooltipContent = `
                    <div class="flight-model">${model}</div>
                    <div class="flight-number-line">
                        <span class="flag-emoji">${flagEmoji}</span>
                        <span>${callsign}</span>
                    </div>
                    <div class="flight-route">${route.origin} > ${route.dest} (${distanceKm} km)</div>
                `;

                if (flightMarkers[icao24]) { // Update existing
                    flightMarkers[icao24].marker.setLatLng(position);
                    flightMarkers[icao24].marker.getTooltip().setContent(tooltipContent);
                    const iconEl = flightMarkers[icao24].marker.getElement().querySelector('.airplane-icon');
                    if (iconEl && true_track !== null) iconEl.style.transform = `rotate(${true_track}deg)`;
                    
                    flightMarkers[icao24].history.push(position);
                    if (flightMarkers[icao24].history.length > 100) flightMarkers[icao24].history.shift();
                    flightMarkers[icao24].path.setLatLngs(flightMarkers[icao24].history);
                } else { // Create new
                    const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="airplane-icon" style="transform: rotate(${true_track || 0}deg);"></div>`, iconSize: [40, 40], iconAnchor: [20, 20] });
                    const marker = L.marker(position, { icon }).addTo(map);
                    marker.bindTooltip(tooltipContent, { permanent: true, direction: 'bottom', offset: L.point(0, 15), className: 'flight-info-tooltip' });
                    const path = L.polyline([position], { color: 'rgba(255, 255, 255, 0.7)', weight: 2 }).addTo(map);
                    flightMarkers[icao24] = { marker, path, history: [position] };
                }
            }

            // Clean up old markers
            for (const icao in flightMarkers) {
                if (!closestIcaos.has(icao)) {
                    map.removeLayer(flightMarkers[icao].marker);
                    map.removeLayer(flightMarkers[icao].path);
                    delete flightMarkers[icao];
                }
            }
        } catch (error) {
            console.error('Error fetching flight data:', error);
        }
    }

    // --- Geolocation and UI ---
    document.getElementById('locate-btn').addEventListener('click', () => {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                homeCoordinates = L.latLng(latitude, longitude);
                map.setView(homeCoordinates, 11);
                if (homeMarker) map.removeLayer(homeMarker);
                homeMarker = L.marker(homeCoordinates).addTo(map).bindPopup("Your Location").openPopup();
                
                // Clear existing flights and fetch new ones
                for (const icao in flightMarkers) {
                    map.removeLayer(flightMarkers[icao].marker);
                    map.removeLayer(flightMarkers[icao].path);
                    delete flightMarkers[icao];
                }
                fetchFlightData();
            },
            (error) => {
                alert(`Could not get your location: ${error.message}`);
            }
        );
    });

    // --- Initial Load ---
    fetchFlightData();
    setInterval(fetchFlightData, 15000); // Increased interval to be kinder to the APIs
</script>

</body>
</html>
